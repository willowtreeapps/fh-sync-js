!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.fhsync=e()}}(function(){return function e(f,n,o){function d(t,l){if(!n[t]){if(!f[t]){var s="function"==typeof require&&require;if(!l&&s)return s(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var u=n[t]={exports:{}};f[t][0].call(u.exports,function(e){var n=f[t][1][e];return d(n?n:e)},u,u.exports,e,f,n,o)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(e,f,n){(function(n){__browserify_shim_require__=e,function(e,f,n,o,d){var i=i||function(e,f){var n={},o=n.lib={},d=o.Base=function(){function e(){}return{extend:function(f){e.prototype=this;var n=new e;return f&&n.mixIn(f),n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var f in e)e.hasOwnProperty(f)&&(this[f]=e[f]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),i=o.WordArray=d.extend({init:function(e,n){e=this.words=e||[],n!=f?this.sigBytes=n:this.sigBytes=4*e.length},toString:function(e){return(e||l).stringify(this)},concat:function(e){var f=this.words,n=e.words,o=this.sigBytes,d=e.sigBytes;if(this.clamp(),o%4)for(var i=0;d>i;i++){var t=n[i>>>2]>>>24-i%4*8&255;f[o+i>>>2]|=t<<24-(o+i)%4*8}else if(n.length>65535)for(var i=0;d>i;i+=4)f[o+i>>>2]=n[i>>>2];else f.push.apply(f,n);return this.sigBytes+=d,this},clamp:function(){var f=this.words,n=this.sigBytes;f[n>>>2]&=4294967295<<32-n%4*8,f.length=e.ceil(n/4)},clone:function(){var e=d.clone.call(this);return e.words=this.words.slice(0),e},random:function(f){for(var n=[],o=0;f>o;o+=4)n.push(4294967296*e.random()|0);return new i.init(n,f)}}),t=n.enc={},l=t.Hex={stringify:function(e){for(var f=e.words,n=e.sigBytes,o=[],d=0;n>d;d++){var i=f[d>>>2]>>>24-d%4*8&255;o.push((i>>>4).toString(16)),o.push((15&i).toString(16))}return o.join("")},parse:function(e){for(var f=e.length,n=[],o=0;f>o;o+=2)n[o>>>3]|=parseInt(e.substr(o,2),16)<<24-o%8*4;return new i.init(n,f/2)}},s=t.Latin1={stringify:function(e){for(var f=e.words,n=e.sigBytes,o=[],d=0;n>d;d++){var i=f[d>>>2]>>>24-d%4*8&255;o.push(String.fromCharCode(i))}return o.join("")},parse:function(e){for(var f=e.length,n=[],o=0;f>o;o++)n[o>>>2]|=(255&e.charCodeAt(o))<<24-o%4*8;return new i.init(n,f)}},u=t.Utf8={stringify:function(e){try{return decodeURIComponent(escape(s.stringify(e)))}catch(f){throw new Error("Malformed UTF-8 data")}},parse:function(e){return s.parse(unescape(encodeURIComponent(e)))}},p=o.BufferedBlockAlgorithm=d.extend({reset:function(){this._data=new i.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(f){var n=this._data,o=n.words,d=n.sigBytes,t=this.blockSize,l=4*t,s=d/l;s=f?e.ceil(s):e.max((0|s)-this._minBufferSize,0);var u=s*t,p=e.min(4*u,d);if(u){for(var c=0;u>c;c+=t)this._doProcessBlock(o,c);var y=o.splice(0,u);n.sigBytes-=p}return new i.init(y,p)},clone:function(){var e=d.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),c=(o.Hasher=p.extend({cfg:d.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){e&&this._append(e);var f=this._doFinalize();return f},blockSize:16,_createHelper:function(e){return function(f,n){return new e.init(n).finalize(f)}},_createHmacHelper:function(e){return function(f,n){return new c.HMAC.init(e,n).finalize(f)}}}),n.algo={});return n}(Math);i.lib.Cipher||function(e){var f=i,n=f.lib,o=n.Base,d=n.WordArray,t=n.BufferedBlockAlgorithm,l=f.enc,s=(l.Utf8,l.Base64),u=f.algo,p=u.EvpKDF,c=n.Cipher=t.extend({cfg:o.extend(),createEncryptor:function(e,f){return this.create(this._ENC_XFORM_MODE,e,f)},createDecryptor:function(e,f){return this.create(this._DEC_XFORM_MODE,e,f)},init:function(e,f,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=f,this.reset()},reset:function(){t.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){e&&this._append(e);var f=this._doFinalize();return f},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return"string"==typeof e?k:h}return function(f){return{encrypt:function(n,o,d){return e(o).encrypt(f,n,o,d)},decrypt:function(n,o,d){return e(o).decrypt(f,n,o,d)}}}}()}),y=(n.StreamCipher=c.extend({_doFinalize:function(){var e=this._process(!0);return e},blockSize:1}),f.mode={}),a=n.BlockCipherMode=o.extend({createEncryptor:function(e,f){return this.Encryptor.create(e,f)},createDecryptor:function(e,f){return this.Decryptor.create(e,f)},init:function(e,f){this._cipher=e,this._iv=f}}),r=y.CBC=function(){function f(f,n,o){var d=this._iv;if(d){var i=d;this._iv=e}else var i=this._prevBlock;for(var t=0;o>t;t++)f[n+t]^=i[t]}var n=a.extend();return n.Encryptor=n.extend({processBlock:function(e,n){var o=this._cipher,d=o.blockSize;f.call(this,e,n,d),o.encryptBlock(e,n),this._prevBlock=e.slice(n,n+d)}}),n.Decryptor=n.extend({processBlock:function(e,n){var o=this._cipher,d=o.blockSize,i=e.slice(n,n+d);o.decryptBlock(e,n),f.call(this,e,n,d),this._prevBlock=i}}),n}(),w=f.pad={},b=w.Pkcs7={pad:function(e,f){for(var n=4*f,o=n-e.sigBytes%n,i=o<<24|o<<16|o<<8|o,t=[],l=0;o>l;l+=4)t.push(i);var s=d.create(t,o);e.concat(s)},unpad:function(e){var f=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=f}},g=(n.BlockCipher=c.extend({cfg:c.cfg.extend({mode:r,padding:b}),reset:function(){c.reset.call(this);var e=this.cfg,f=e.iv,n=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var o=n.createEncryptor;else{var o=n.createDecryptor;this._minBufferSize=1}this._mode=o.call(n,this,f&&f.words)},_doProcessBlock:function(e,f){this._mode.processBlock(e,f)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var f=this._process(!0)}else{var f=this._process(!0);e.unpad(f)}return f},blockSize:4}),n.CipherParams=o.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}})),m=f.format={},x=m.OpenSSL={stringify:function(e){var f=e.ciphertext,n=e.salt;if(n)var o=d.create([1398893684,1701076831]).concat(n).concat(f);else var o=f;return o.toString(s)},parse:function(e){var f=s.parse(e),n=f.words;if(1398893684==n[0]&&1701076831==n[1]){var o=d.create(n.slice(2,4));n.splice(0,4),f.sigBytes-=16}return g.create({ciphertext:f,salt:o})}},h=n.SerializableCipher=o.extend({cfg:o.extend({format:x}),encrypt:function(e,f,n,o){o=this.cfg.extend(o);var d=e.createEncryptor(n,o),i=d.finalize(f),t=d.cfg;return g.create({ciphertext:i,key:n,iv:t.iv,algorithm:e,mode:t.mode,padding:t.padding,blockSize:e.blockSize,formatter:o.format})},decrypt:function(e,f,n,o){o=this.cfg.extend(o),f=this._parse(f,o.format);var d=e.createDecryptor(n,o).finalize(f.ciphertext);return d},_parse:function(e,f){return"string"==typeof e?f.parse(e,this):e}}),j=f.kdf={},v=j.OpenSSL={execute:function(e,f,n,o){o||(o=d.random(8));var i=p.create({keySize:f+n}).compute(e,o),t=d.create(i.words.slice(f),4*n);return i.sigBytes=4*f,g.create({key:i,iv:t,salt:o})}},k=n.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:v}),encrypt:function(e,f,n,o){o=this.cfg.extend(o);var d=o.kdf.execute(n,e.keySize,e.ivSize);o.iv=d.iv;var i=h.encrypt.call(this,e,f,d.key,o);return i.mixIn(d),i},decrypt:function(e,f,n,o){o=this.cfg.extend(o),f=this._parse(f,o.format);var d=o.kdf.execute(n,e.keySize,e.ivSize,f.salt);o.iv=d.iv;var i=h.decrypt.call(this,e,f,d.key,o);return i}})}(),function(){var e=i,f=e.lib,n=f.WordArray,o=f.Hasher,d=e.algo,t=[],l=d.SHA1=o.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,f){for(var n=this._hash.words,o=n[0],d=n[1],i=n[2],l=n[3],s=n[4],u=0;80>u;u++){if(16>u)t[u]=0|e[f+u];else{var p=t[u-3]^t[u-8]^t[u-14]^t[u-16];t[u]=p<<1|p>>>31}var c=(o<<5|o>>>27)+s+t[u];c+=20>u?(d&i|~d&l)+1518500249:40>u?(d^i^l)+1859775393:60>u?(d&i|d&l|i&l)-1894007588:(d^i^l)-899497514,s=l,l=i,i=d<<30|d>>>2,d=o,o=c}n[0]=n[0]+o|0,n[1]=n[1]+d|0,n[2]=n[2]+i|0,n[3]=n[3]+l|0,n[4]=n[4]+s|0},_doFinalize:function(){var e=this._data,f=e.words,n=8*this._nDataBytes,o=8*e.sigBytes;return f[o>>>5]|=128<<24-o%32,f[(o+64>>>9<<4)+14]=Math.floor(n/4294967296),f[(o+64>>>9<<4)+15]=n,e.sigBytes=4*f.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=o._createHelper(l),e.HmacSHA1=o._createHmacHelper(l)}(),function(e){var f=i,n=f.lib,o=n.Base,d=n.WordArray,t=f.x64={};t.Word=o.extend({init:function(e,f){this.high=e,this.low=f}}),t.WordArray=o.extend({init:function(f,n){f=this.words=f||[],n!=e?this.sigBytes=n:this.sigBytes=8*f.length},toX32:function(){for(var e=this.words,f=e.length,n=[],o=0;f>o;o++){var i=e[o];n.push(i.high),n.push(i.low)}return d.create(n,this.sigBytes)},clone:function(){for(var e=o.clone.call(this),f=e.words=this.words.slice(0),n=f.length,d=0;n>d;d++)f[d]=f[d].clone();return e}})}(),d("undefined"!=typeof i?i:window.CryptoJS)}.call(n,void 0,void 0,void 0,void 0,function(e){f.exports=e})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,f,n){(function(n){__browserify_shim_require__=e,function(e,f,n,o,d){var i=function(e,f){if(!(this instanceof i))return new i(e,f);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(!(arguments.length<=2&&arguments.length>0))throw"Incorrect # of ctor args!";if(f="function"==typeof arguments[0]?arguments[0]:arguments[1],e="function"==typeof arguments[0]?{}:arguments[0],"function"!=typeof f)throw"No callback was provided";this.record=e.record||"record",this.name=e.name||"records";var n;if(e.adapter){"string"==typeof e.adapter&&(e.adapter=[e.adapter]);for(var o=0,d=e.adapter.length;d>o;o++){for(var t=i.adapters.length-1;t>=0&&(i.adapters[t].adapter!==e.adapter[o]||!(n=i.adapters[t].valid()?i.adapters[t]:void 0));t--);if(n)break}}else for(var t=0,l=i.adapters.length;l>t&&!(n=i.adapters[t].valid()?i.adapters[t]:void 0);t++);if(!n)throw"No valid adapter.";for(var o in n)this[o]=n[o];for(var t=0,l=i.plugins.length;l>t;t++)i.plugins[t].call(this);this.init(e,f)};i.adapters=[],i.adapter=function(e,f){f.adapter=e;var n="adapter valid init keys save batch get exists all remove nuke".split(" "),o=this.prototype.indexOf;for(var d in f)if(-1===o(n,d))throw"Invalid adapter! Nonstandard method: "+d;i.adapters.splice(0,0,f)},i.plugins=[],i.plugin=function(e){for(var f in e)"init"===f?i.plugins.push(e[f]):this.prototype[f]=e[f]},i.prototype={isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},indexOf:function(e,f,n,o){if(e.indexOf)return e.indexOf(f);for(n=0,o=e.length;o>n;n++)if(e[n]===f)return n;return-1},lambda:function(e){return this.fn(this.record,e)},fn:function(e,f){return"string"==typeof f?new Function(e,f):f},uuid:function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},each:function(e){var f=this.lambda(e);if(this.__results)for(var n=0,o=this.__results.length;o>n;n++)f.call(this,this.__results[n],n);else this.all(function(e){for(var n=0,o=e.length;o>n;n++)f.call(this,e[n],n)});return this}},i.adapter("window-name",function(){"undefined"==typeof window&&(window={top:{}});var e={};try{e=JSON.parse(window.top.name)}catch(f){}return{valid:function(){return"undefined"!=typeof window.top.name},init:function(f,n){return e[this.name]=e[this.name]||{index:[],store:{}},this.index=e[this.name].index,this.store=e[this.name].store,this.fn(this.name,n).call(this,this),this},keys:function(e){return this.fn("keys",e).call(this,this.index),this},save:function(f,n){var o=f.key||this.uuid();return this.exists(o,function(d){d||(f.key&&delete f.key,this.index.push(o)),this.store[o]=f;try{window.top.name=JSON.stringify(e)}catch(i){throw d||(this.index.pop(),delete this.store[o]),i}n&&(f.key=o,this.lambda(n).call(this,f))}),this},batch:function(e,f){for(var n=[],o=0,d=e.length;d>o;o++)this.save(e[o],function(e){n.push(e)});return f&&this.lambda(f).call(this,n),this},get:function(e,f){var n;if(this.isArray(e)){n=[];for(var o=0,d=e.length;d>o;o++)n.push(this.store[e[o]])}else n=this.store[e],n&&(n.key=e);return f&&this.lambda(f).call(this,n),this},exists:function(e,f){return this.lambda(f).call(this,!!this.store[e]),this},all:function(e){for(var f=[],n=0,o=this.index.length;o>n;n++){var d=this.store[this.index[n]];d.key=this.index[n],f.push(d)}return this.fn(this.name,e).call(this,f),this},remove:function(f,n){for(var o=this.isArray(f)?f:[f],d=0,i=o.length;i>d;d++){var t=o[d].key?o[d].key:o[d],l=this.indexOf(this.index,t);0>l||(delete this.store[t],this.index.splice(l,1))}return window.top.name=JSON.stringify(e),n&&this.lambda(n).call(this),this},nuke:function(f){return this.store=e[this.name].store={},this.index=e[this.name].index=[],window.top.name=JSON.stringify(e),f&&this.lambda(f).call(this),this}}}()),i.adapter("dom",function(){var e=null;try{e=window.localStorage}catch(f){}var n=function(f){return{key:f+"._index_",all:function(){var f=e.getItem(this.key);return f&&(f=JSON.parse(f)),null===f&&e.setItem(this.key,JSON.stringify([])),JSON.parse(e.getItem(this.key))},add:function(f){var n=this.all();n.push(f),e.setItem(this.key,JSON.stringify(n))},del:function(f){for(var n=this.all(),o=[],d=0,i=n.length;i>d;d++)n[d]!=f&&o.push(n[d]);e.setItem(this.key,JSON.stringify(o))},find:function(e){for(var f=this.all(),n=0,o=f.length;o>n;n++)if(e===f[n])return n;return!1}}};return{valid:function(){return!!e&&function(){var f=!0,n=Math.random();try{e.setItem(n,n)}catch(o){f=!1}return e.removeItem(n),f}()},init:function(e,f){this.indexer=n(this.name),f&&this.fn(this.name,f).call(this,this)},save:function(f,n){var o=f.key?this.name+"."+f.key:this.name+"."+this.uuid();return delete f.key,e.setItem(o,JSON.stringify(f)),this.indexer.find(o)===!1&&this.indexer.add(o),f.key=o.slice(this.name.length+1),n&&this.lambda(n).call(this,f),this},batch:function(e,f){for(var n=[],o=0,d=e.length;d>o;o++)this.save(e[o],function(e){n.push(e)});return f&&this.lambda(f).call(this,n),this},keys:function(e){if(e){var f=this.name,n=this.indexer.all(),o=[];if(Array.prototype.map)o=n.map(function(e){return e.replace(f+".","")});else for(var d in n)o.push(d.replace(f+".",""));this.fn("keys",e).call(this,o)}return this},get:function(f,n){if(this.isArray(f)){for(var o=[],d=0,i=f.length;i>d;d++){var t=this.name+"."+f[d],l=e.getItem(t);l&&(l=JSON.parse(l),l.key=f[d]),o.push(l)}n&&this.lambda(n).call(this,o)}else{var t=this.name+"."+f,l=e.getItem(t);l&&(l=JSON.parse(l),l.key=f),n&&this.lambda(n).call(this,l)}return this},exists:function(e,f){var n=this.indexer.find(this.name+"."+e)===!1?!1:!0;return this.lambda(f).call(this,n),this},all:function(f){for(var n,o,d=this.indexer.all(),i=[],t=0,l=d.length;l>t;t++)o=d[t],n=JSON.parse(e.getItem(o)),n.key=o.replace(this.name+".",""),i.push(n);return f&&this.fn(this.name,f).call(this,i),this},remove:function(f,n){var o=this;if(this.isArray(f)){var d,i=f.length,t=function(e){o.remove(f[e],function(){--i>0||n&&o.lambda(n).call(o)})};for(d=0;d<f.length;d++)t(d);return this}var l=this.name+"."+(f.key?f.key:f);return this.indexer.del(l),e.removeItem(l),n&&this.lambda(n).call(this),this},nuke:function(e){return this.all(function(f){for(var n=0,o=f.length;o>n;n++)this.remove(f[n]);e&&this.lambda(e).call(this)}),this}}}()),i.adapter("webkit-sqlite",function(){var e=function(e,f){console&&console.log("error in sqlite adaptor!",e,f)},f=function(){return new Date};return{valid:function(){return!!window.openDatabase},init:function(f,n){var o=this,d=o.fn(o.name,n),i="CREATE TABLE IF NOT EXISTS "+this.record+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",t=function(){return d.call(o,o)};f&&"function"==typeof f.fail&&(e=f.fail),this.db=openDatabase(this.name,"1.0.0",this.name,65536),this.db.transaction(function(f){f.executeSql(i,[],t,e)})},keys:function(f){var n=this.lambda(f),o=this,d="SELECT id FROM "+this.record+" ORDER BY timestamp DESC";return this.db.readTransaction(function(f){var i=function(e,f){if(0==f.rows.length)n.call(o,[]);else{for(var d=[],i=0,t=f.rows.length;t>i;i++)d.push(f.rows.item(i).id);n.call(o,d)}};f.executeSql(d,[],i,e)}),this},save:function(n,o,d){var i=this;objs=(this.isArray(n)?n:[n]).map(function(e){return e.key||(e.key=i.uuid()),e}),ins="INSERT OR REPLACE INTO "+this.record+" (value, timestamp, id) VALUES (?,?,?)",win=function(){o&&i.lambda(o).call(i,i.isArray(n)?objs:objs[0])},d=d||function(){},insvals=[],ts=f();try{for(var t=0,l=objs.length;l>t;t++)insvals[t]=[JSON.stringify(objs[t]),ts,objs[t].key]}catch(s){throw e(s),s}return i.db.transaction(function(e){for(var f=0,n=objs.length;n>f;f++)e.executeSql(ins,insvals[f])},function(f,n){e(f,n)},win),this},batch:function(e,f){return this.save(e,f)},get:function(f,n){var o=this,d="",i=this.isArray(f)?f:[f];d="SELECT id, value FROM "+this.record+" WHERE id IN ("+i.map(function(){return"?"}).join(",")+")";var t=function(e,d){for(var t,l,s={},u=0,p=d.rows.length;p>u;u++)t=JSON.parse(d.rows.item(u).value),t.key=d.rows.item(u).id,s[t.key]=t;l=i.map(function(e){return s[e]}),o.isArray(f)||(l=l.length?l[0]:null),n&&o.lambda(n).call(o,l)};return this.db.readTransaction(function(f){f.executeSql(d,i,t,e)}),this},exists:function(f,n){var o="SELECT * FROM "+this.record+" WHERE id = ?",d=this,i=function(e,f){n&&d.fn("exists",n).call(d,f.rows.length>0)};return this.db.readTransaction(function(n){n.executeSql(o,[f],i,e)}),this},all:function(f){var n=this,o="SELECT * FROM "+this.record,d=[],i=this.fn(this.name,f)||void 0,t=function(e,f){if(0!=f.rows.length)for(var o=0,t=f.rows.length;t>o;o++){var l=JSON.parse(f.rows.item(o).value);l.key=f.rows.item(o).id,d.push(l)}i&&i.call(n,d)};return this.db.readTransaction(function(f){f.executeSql(o,[],t,e)}),this},remove:function(f,n){var o,d=this,i="DELETE FROM "+this.record+" WHERE id ",t=function(){n&&d.lambda(n).call(d)};return this.isArray(f)?(o=f,i+="IN ("+o.map(function(){return"?"}).join(",")+")"):(i+="= ?",o=[f]),o=o.map(function(e){return e.key?e.key:e}),this.db.transaction(function(f){f.executeSql(i,o,t,e)}),this},nuke:function(f){var n="DELETE FROM "+this.record,o=this,d=f?function(){o.lambda(f).call(o)}:function(){};return this.db.transaction(function(f){f.executeSql(n,[],d,e)}),this}}}()),i.adapter("indexed-db",function(){function e(e,f){console&&console.log("error in indexed-db adapter!"+e.message,e,f)}function f(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB}return{valid:function(){return!!f()},init:function(n,o){this.idb=f(),this.waiting=[];var d=this.idb.open(this.name,2),i=this,t=i.fn(i.name,o),l=function(){return t.call(i,i)};n&&"function"==typeof n.fail&&(e=n.fail),d.onupgradeneeded=function(e){i.store=d.result.createObjectStore("teststore",{autoIncrement:!0});for(var f=0;f<i.waiting.length;f++)i.waiting[f].call(i);i.waiting=[],l()},d.onsuccess=function(f){if(i.db=d.result,"2.0"!=i.db.version){if("function"==typeof i.db.setVersion){var n=i.db.setVersion("2.0");n.onsuccess=function(e){i.store=i.db.createObjectStore("teststore",{autoIncrement:!0});for(var f=0;f<i.waiting.length;f++)i.waiting[f].call(i);i.waiting=[],l()},n.onerror=function(f){e(f)}}}else{i.store={};for(var o=0;o<i.waiting.length;o++)i.waiting[o].call(i);i.waiting=[],l()}},d.onerror=e},save:function(f,n){if(!this.store)return void this.waiting.push(function(){this.save(f,n)});var o=this,d=function(e){n&&(f.key=e.target.result,o.lambda(n).call(o,f))},i="readwrite",t=this.db.transaction(["teststore"],i),l=t.objectStore("teststore"),s=f.key?l.put(f,f.key):l.put(f);return s.onsuccess=d,s.onerror=e,this},batch:function(e,f){for(var n=[],o=!1,d=this,i=function(f){n.push(f),o=n.length===e.length},t=setInterval(function(){o&&(f&&d.lambda(f).call(d,n),clearInterval(t))},200),l=0,s=e.length;s>l;l++)this.save(e[l],i);return this},get:function(f,n){if(!this.store||!this.db)return void this.waiting.push(function(){this.get(f,n)});var o=this,d=function(e){n&&o.lambda(n).call(o,e.target.result)};if(this.isArray(f))for(var i=[],t=!1,l=f,s=function(e){i.push(e),t=i.length===l.length},u=setInterval(function(){t&&(n&&o.lambda(n).call(o,i),clearInterval(u))},200),p=0,c=l.length;c>p;p++)this.get(l[p],s);else{var y=this.db.transaction("teststore").objectStore("teststore").get(f);y.onsuccess=d,y.onerror=function(f){e(f)}}return this},all:function(e){if(!this.store)return void this.waiting.push(function(){this.all(e)});var f=this.fn(this.name,e)||void 0,n=this,o=this.db.transaction("teststore").objectStore("teststore"),d=[];return o.openCursor().onsuccess=function(e){var o=e.target.result;o?(d.push(o.value),o["continue"]()):f&&f.call(n,d)},this},remove:function(f,n){if(!this.store)return void this.waiting.push(function(){this.remove(f,n)});"object"==typeof f&&(f=f.key);var o=this,d=function(){n&&o.lambda(n).call(o)},i=this.db.transaction(["teststore"],"readwrite").objectStore("teststore")["delete"](f);return i.onsuccess=d,i.onerror=e,this},nuke:function(f){if(!this.store)return void this.waiting.push(function(){this.nuke(f)});var n=this,o=f?function(){n.lambda(f).call(n)}:function(){};try{this.db.transaction(["teststore"],"readwrite").objectStore("teststore").clear().onsuccess=o}catch(d){e()}return this}}}()),i.adapter("html5-filesystem",function(e){var f=function(e){console&&console.error(e,e.name)},n=function(e,o,d){var i=d||[];e.readEntries(function(f){f.length?n(e,o,i.concat(Array.prototype.slice.call(f))):o&&o(i.map(function(e){return e.name}))},f)},o={},d=function(e,f){var n=o[e.name];n?f(n):setTimeout(function(){d(e,f)},10)},i=function(){var e=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://");return e?!0:!1},t=function(e){var f;if(i())f=e;else{var n="application/json";try{f=new Blob([e],{type:n})}catch(o){var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if("TypeError"==o.name&&d){var t=new d;t.append([e.buffer]),f=t.getBlob(n)}else f=e}}return f};return{valid:function(){var f=e.requestFileSystem||e.webkitRequestFileSystem||e.moz_requestFileSystem;return!!f},init:function(n,d){function i(f){var n=e.requestFileSystem||e.webkitRequestFileSystem||e.moz_requestFileSystem,i=window.PERSISTENT;"undefined"!=typeof LocalFileSystem&&"undefined"!=typeof LocalFileSystem.PERSISTENT&&(i=LocalFileSystem.PERSISTENT),n(i,f,function(e){e.root.getDirectory(u,{create:!0},function(e){o[u]=e,d&&t.fn(t.name,d).call(t,t)},function(e){l(e)})},function(e){l(e)})}var t=this,l=function(e){f(e),d&&t.fn(t.name,d).call(t,t)},s=n.size||104857600,u=this.name;t.backup=!1,"undefined"!=typeof n.backup&&(t.backup=n.backup),"undefined"!=typeof navigator.webkitPersistentStorage?navigator.webkitPersistentStorage.requestQuota(s,i,function(){logger.warn("User declined file storage"),l("User declined file storage")}):i(0)},keys:function(e){var f=this;return d(this,function(o){n(o.createReader(),function(n){e&&f.fn("keys",e).call(f,n)})}),this},save:function(e,n){var o=this,i=e.key||this.uuid();e.key=i;var l=function(e){f(e),n&&o.lambda(n).call(o)};return d(this,function(f){var d=function(f,d){f.createWriter(function(f){f.onerror=d,f.onwriteend=function(){this.onwriteend=null,this.truncate(this.position),n&&o.lambda(n).call(o,e)};var i=JSON.stringify(e),l=t(i);f.write(l)},d)};f.getFile(i,{create:!0},function(e){"function"!=typeof e.setMetadata||o.backup!==!1&&"false"!==o.backup?d(e,l):e.setMetadata(function(){d(e,l)},function(){d(e,l)},{"com.apple.MobileBackup":1})},l)}),this},batch:function(e,f){for(var n=this,o=[],d=0,i=e.length;i>d;d++)n.save(e[d],function(e){o.push(e),o.length===i&&f&&n.lambda(f).call(n,o)});return this},get:function(e,n){var o=this;if(this.isArray(e))for(var i=[],t=0,l=e.length;l>t;t++)o.get(e[t],function(e){e&&i.push(e),i.length===l&&n&&o.lambda(n).call(o,i)});else{var s=function(e){f(e),n&&o.lambda(n).call(o)};d(this,function(f){f.getFile(e,{create:!1},function(f){f.file(function(f){var d=new FileReader;d.onerror=s,d.onload=function(f){var d={};try{d=JSON.parse(f.target.result),d.key=e}catch(f){d={key:e}}n&&o.lambda(n).call(o,d)},d.readAsText(f)},s)},s)})}return this},exists:function(e,f){var n=this;return d(this,function(o){o.getFile(e,{create:!1},function(){f&&n.lambda(f).call(n,!0)},function(){f&&n.lambda(f).call(n,!1)})}),this},all:function(e){var f=this;return e&&this.keys(function(n){n.length?f.get(n,function(n){f.fn(f.name,e).call(f,n)}):f.fn(f.name,e).call(f,[])}),this},remove:function(e,n){var o=this,i=function(e){f(e),n&&o.lambda(n).call(o)};return d(this,function(f){f.getFile("string"==typeof e?e:e.key,{create:!1},function(e){e.remove(function(){n&&o.lambda(n).call(o)},i)},i)}),this},nuke:function(e){var f=this,n=0;return this.keys(function(o){if(o.length)for(var d=0,i=o.length;i>d;d++)f.remove(o[d],function(){n++,n===i&&e&&f.lambda(e).call(f)});else e&&f.lambda(e).call(f)}),this}}}(this)),i.adapter("memory",function(){var e={};return{valid:function(){return!0},init:function(f,n){e[this.name]=e[this.name]||{index:[],store:{}},this.index=e[this.name].index,this.store=e[this.name].store;var o=this.fn(this.name,n);return o&&o.call(this,this),this},keys:function(e){return this.fn("keys",e).call(this,this.index),this},save:function(e,f){var n=e.key||this.uuid();return this.exists(n,function(o){o||(e.key&&delete e.key,this.index.push(n)),this.store[n]=e,f&&(e.key=n,this.lambda(f).call(this,e))}),this},batch:function(e,f){for(var n=[],o=0,d=e.length;d>o;o++)this.save(e[o],function(e){n.push(e)});return f&&this.lambda(f).call(this,n),this},get:function(e,f){var n;if(this.isArray(e)){n=[];for(var o=0,d=e.length;d>o;o++)n.push(this.store[e[o]])}else n=this.store[e],n&&(n.key=e);return f&&this.lambda(f).call(this,n),this},exists:function(e,f){return this.lambda(f).call(this,!!this.store[e]),this},all:function(e){for(var f=[],n=0,o=this.index.length;o>n;n++){var d=this.store[this.index[n]];d.key=this.index[n],f.push(d)}return this.fn(this.name,e).call(this,f),this},remove:function(e,f){for(var n=this.isArray(e)?e:[e],o=0,d=n.length;d>o;o++){var i=n[o].key?n[o].key:n[o],t=this.indexOf(this.index,i);0>t||(delete this.store[i],this.index.splice(t,1))}return f&&this.lambda(f).call(this),this},nuke:function(f){return this.store=e[this.name].store={},this.index=e[this.name].index=[],f&&this.lambda(f).call(this),this}}}()),d("undefined"!=typeof i?i:window.Lawnchair)}.call(n,void 0,void 0,void 0,void 0,function(e){f.exports=e})}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,f,n){var o=e("./v1"),d=e("./v4"),i=d;i.v1=o,i.v4=d,f.exports=i},{"./v1":6,"./v4":7}],4:[function(e,f,n){function o(e,f){var n=f||0,o=d;return o[e[n++]]+o[e[n++]]+o[e[n++]]+o[e[n++]]+"-"+o[e[n++]]+o[e[n++]]+"-"+o[e[n++]]+o[e[n++]]+"-"+o[e[n++]]+o[e[n++]]+"-"+o[e[n++]]+o[e[n++]]+o[e[n++]]+o[e[n++]]+o[e[n++]]+o[e[n++]]}for(var d=[],i=0;256>i;++i)d[i]=(i+256).toString(16).substr(1);f.exports=o},{}],5:[function(e,f,n){(function(e){var n,o=e.crypto||e.msCrypto;if(o&&o.getRandomValues){var d=new Uint8Array(16);n=function(){return o.getRandomValues(d),d}}if(!n){var i=new Array(16);n=function(){for(var e,f=0;16>f;f++)0===(3&f)&&(e=4294967296*Math.random()),i[f]=e>>>((3&f)<<3)&255;return i}}f.exports=n}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(e,f,n){function o(e,f,n){var o=f&&n||0,d=f||[];e=e||{};var t=void 0!==e.clockseq?e.clockseq:s,c=void 0!==e.msecs?e.msecs:(new Date).getTime(),y=void 0!==e.nsecs?e.nsecs:p+1,a=c-u+(y-p)/1e4;if(0>a&&void 0===e.clockseq&&(t=t+1&16383),(0>a||c>u)&&void 0===e.nsecs&&(y=0),y>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");u=c,p=y,s=t,c+=122192928e5;var r=(1e4*(268435455&c)+y)%4294967296;d[o++]=r>>>24&255,d[o++]=r>>>16&255,d[o++]=r>>>8&255,d[o++]=255&r;var w=c/4294967296*1e4&268435455;d[o++]=w>>>8&255,d[o++]=255&w,d[o++]=w>>>24&15|16,d[o++]=w>>>16&255,d[o++]=t>>>8|128,d[o++]=255&t;for(var b=e.node||l,g=0;6>g;++g)d[o+g]=b[g];return f?f:i(d)}var d=e("./lib/rng"),i=e("./lib/bytesToUuid"),t=d(),l=[1|t[0],t[1],t[2],t[3],t[4],t[5]],s=16383&(t[6]<<8|t[7]),u=0,p=0;f.exports=o},{"./lib/bytesToUuid":4,"./lib/rng":5}],7:[function(e,f,n){function o(e,f,n){var o=f&&n||0;"string"==typeof e&&(f="binary"==e?new Array(16):null,e=null),e=e||{};var t=e.random||(e.rng||d)();if(t[6]=15&t[6]|64,t[8]=63&t[8]|128,f)for(var l=0;16>l;++l)f[o+l]=t[l];return f||i(t)}var d=e("./lib/rng"),i=e("./lib/bytesToUuid");f.exports=o},{"./lib/bytesToUuid":4,"./lib/rng":5}],8:[function(e,f,n){function o(){if(window&&window.device)return window.device.uuid;if(navigator&&navigator.device)return navigator.device.uuid;if(window&&window.localStorage){var e=window.localStorage.getItem(i);return e||(e=d(),localStorage.setItem(i,e)),e}throw Error("Cannot create and store client id")}var d=e("uuid").v1,i="feedhenry_sync_client";f.exports={getClientId:o}},{uuid:3}],9:[function(e,f,n){var o,d,i=function(e,f,n){d||(d="/sync/");var i=o+d+e.dataset_id,t=e.req,l=JSON.stringify(t),s=new XMLHttpRequest;s.open("POST",i,!0),s.setRequestHeader("Content-type","application/json; charset=utf-8"),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300||304===s.status){var e;try{s.responseText&&(e=JSON.parse(s.responseText))}catch(o){return n(o)}f(e)}else n(s.responseText)},s.send(l)},t=function(e,f){o=e,d=f};f.exports={handler:i,init:t}},{}],10:[function(e,f,n){var o=e("./sync-client"),d=window.$fh=window.$fh||{};d.sync=o,f.exports=d.sync},{"./sync-client":11}],11:[function(e,f,n){var o=e("../libs/generated/crypto"),d=e("../libs/generated/lawnchair"),i=e("./cloudHandler"),t=e("./clientIdProvider"),l=6e4,s={defaults:{sync_frequency:10,auto_sync_local_updates:!0,notify_client_storage_failed:!0,notify_sync_started:!0,notify_sync_complete:!0,notify_offline_update:!0,notify_collision_detected:!0,notify_remote_update_failed:!0,notify_local_update_applied:!0,notify_remote_update_applied:!0,notify_delta_received:!0,notify_record_delta_received:!0,notify_sync_failed:!0,do_console_log:!1,crashed_count_wait:10,resend_crashed_updates:!0,sync_active:!0,storage_strategy:"html5-filesystem",file_system_quota:61644800,icloud_backup:!1,resend_inflight_pendings_minutes:1440},notifications:{CLIENT_STORAGE_FAILED:"client_storage_failed",SYNC_STARTED:"sync_started",SYNC_COMPLETE:"sync_complete",OFFLINE_UPDATE:"offline_update",COLLISION_DETECTED:"collision_detected",REMOTE_UPDATE_FAILED:"remote_update_failed",REMOTE_UPDATE_APPLIED:"remote_update_applied",LOCAL_UPDATE_APPLIED:"local_update_applied",DELTA_RECEIVED:"delta_received",RECORD_DELTA_RECEIVED:"record_delta_received",SYNC_FAILED:"sync_failed"},datasets:{},config:void 0,notify_callback:void 0,notify_callback_map:{},init_is_called:!1,uid_map:{},init:function(e){s.consoleLog("sync - init called"),s.config=JSON.parse(JSON.stringify(s.defaults));for(var f in e)s.config[f]=e[f];s.init_is_called||(s.init_is_called=!0,s.datasetMonitor()),i.init(s.config.cloudUrl,s.config.cloudPath)},notify:function(e,f){1===arguments.length&&"function"==typeof e?s.notify_callback=e:s.notify_callback_map[e]=f},manage:function(e,f,n,o,d){s.consoleLog("manage - START"),s.config||(s.config=JSON.parse(JSON.stringify(s.defaults)));var i=f||{},t=function(f){s.consoleLog("doManage dataset :: initialised = "+f.initialised+" :: "+e+" :: "+JSON.stringify(i));var t=f.config?f.config:s.config,l=s.setOptions(t,i);f.query_params=n||f.query_params||{},
f.meta_data=o||f.meta_data||{},f.config=l,f.syncRunning=!1,f.syncPending=!0,f.initialised=!0,"undefined"==typeof f.meta&&(f.meta={}),s.saveDataSet(e,function(){d&&d()})};s.getDataSet(e,function(e){s.consoleLog("manage - dataset already loaded"),t(e)},function(f){s.consoleLog("manage - dataset not loaded... trying to load"),s.loadDataSet(e,function(f){s.consoleLog("manage - dataset loaded from local storage"),s.doNotify(e,null,s.notifications.LOCAL_UPDATE_APPLIED,"load"),t(f)},function(f){s.consoleLog("manage - Creating new dataset for id "+e);var n={};n.data={},n.pending={},n.meta={},s.datasets[e]=n,t(n)})})},setOptions:function(e,f){e||(e=JSON.parse(JSON.stringify(s.defaults)));var n=JSON.parse(JSON.stringify(e)),o=JSON.parse(JSON.stringify(f));for(var d in o)n[d]=o[d];return n},list:function(e,f,n){s.getDataSet(e,function(e){if(e&&e.data){var o=JSON.parse(JSON.stringify(e.data));f(o)}else n&&n("no_data")},function(e,f){n&&n(e,f)})},getUID:function(e){var f=s.uid_map[e];return f||0===f?f:e},create:function(e,f,n,o){return null==f&&o?o("null_data"):void s.addPendingObj(e,null,f,"create",n,o)},read:function(e,f,n,o){s.getDataSet(e,function(e){f=s.getUID(f);var d=e.data[f];if(d){var i=JSON.parse(JSON.stringify(d));n(i)}else o("unknown_uid")},function(e,f){o&&o(e,f)})},update:function(e,f,n,o,d){f=s.getUID(f),s.addPendingObj(e,f,n,"update",o,d)},"delete":function(e,f,n,o){f=s.getUID(f),s.addPendingObj(e,f,null,"delete",n,o)},getPending:function(e,f){s.getDataSet(e,function(e){var n;e&&(n=e.pending),f(n)},function(e,f){s.consoleLog(e)})},clearPending:function(e,f){s.getDataSet(e,function(n){n.pending={},s.saveDataSet(e,f)})},listCollisions:function(e,f,n){s.getDataSet(e,function(o){s.doCloudCall({dataset_id:e,req:{fn:"listCollisions",meta_data:o.meta_data}},f,n)},n)},removeCollision:function(e,f,n,o){s.getDataSet(e,function(d){s.doCloudCall({dataset_id:e,req:{fn:"removeCollision",hash:f,meta_data:d.meta_data}},n,o)})},setNetworkStatusHandler:function(e){handler&&"function"==typeof handler?s.isOnline=handler:s.consoleLog("setNetworkStatusHandler called  with wrong parameter")},isOnline:function(e){var f=!0;if("undefined"!=typeof navigator.onLine&&(f=navigator.onLine),f&&"undefined"!=typeof navigator.network&&"undefined"!=typeof navigator.network.connection){var n=navigator.network.connection.type;("none"===n||null===n)&&(f=!1)}return e(f)},doNotify:function(e,f,n,o){if(s.notify_callback||s.notify_callback_map[e]){var d=s.notify_callback_map[e]||s.notify_callback;if(s.config["notify_"+n]){var i={dataset_id:e,uid:f,code:n,message:o};setTimeout(function(){d(i)},0)}}},getDataSet:function(e,f,n){var o=s.datasets[e];o?f(o):n&&n("unknown_dataset "+e,e)},getQueryParams:function(e,f,n){var o=s.datasets[e];o?f(o.query_params):n&&n("unknown_dataset "+e,e)},setQueryParams:function(e,f,n,o){var d=s.datasets[e];d?(d.query_params=f,s.saveDataSet(e),n&&n(d.query_params)):o&&o("unknown_dataset "+e,e)},getMetaData:function(e,f,n){var o=s.datasets[e];o?f(o.meta_data):n&&n("unknown_dataset "+e,e)},setMetaData:function(e,f,n,o){var d=s.datasets[e];d?(d.meta_data=f,s.saveDataSet(e),n&&n(d.meta_data)):o&&o("unknown_dataset "+e,e)},getConfig:function(e,f,n){var o=s.datasets[e];o?f(o.config):n&&n("unknown_dataset "+e,e)},setConfig:function(e,f,n,o){var d=s.datasets[e];if(d){var i=s.setOptions(d.config,f);d.config=i,s.saveDataSet(e),n&&n(d.config)}else o&&o("unknown_dataset "+e,e)},stopSync:function(e,f,n){s.setConfig(e,{sync_active:!1},function(){f&&f()},n)},startSync:function(e,f,n){s.setConfig(e,{sync_active:!0},function(){f&&f()},n)},doSync:function(e,f,n){var o=s.datasets[e];o?(o.syncPending=!0,s.saveDataSet(e),f&&f()):n&&n("unknown_dataset "+e,e)},forceSync:function(e,f,n){var o=s.datasets[e];if(o){o.syncForced=!0;var d=o.query_params;d.manualRefresh=!0,o.query_params=d,s.saveDataSet(e),f&&f()}else n&&n("unknown_dataset "+e,e)},sortObject:function(e){if("object"!=typeof e||null===e)return e;var f=[];return Object.keys(e).sort().forEach(function(n){f.push({key:n,value:s.sortObject(e[n])})}),f},sortedStringify:function(e){var f="";try{f=JSON.stringify(s.sortObject(e))}catch(n){console.error("Error stringifying sorted object:"+n)}return f},generateHash:function(e){var f=s.getHashMethod(s.sortedStringify(e));return f.toString()},shouldResendInflightPending:function(e,f){if(e.config&&e.config.resend_inflight_pendings_minutes>0&&f.inFlight&&f.inFlightDate&&!f.crashed){var n=(new Date).getTime(),o=n-f.inFlightDate;if(o>=e.config.resend_inflight_pendings_minutes*l)return!0}return!1},addPendingObj:function(e,f,n,o,d,i){function t(n){n.hash=n.hash||s.generateHash(n),s.getDataSet(e,function(i){i.pending[n.hash]=n,s.updateDatasetFromLocal(i,n),s.config.auto_sync_local_updates&&(i.syncPending=!0),s.saveDataSet(e),s.doNotify(e,f,s.notifications.LOCAL_UPDATE_APPLIED,o),d(n)},function(e,f){i&&i(e,f)})}s.isOnline(function(n){n||s.doNotify(e,f,s.notifications.OFFLINE_UPDATE,o)});var l={};l.inFlight=!1,l.action=o,l.post=JSON.parse(JSON.stringify(n)),l.postHash=s.generateHash(l.post),l.timestamp=(new Date).getTime(),"create"===o?(l.hash=s.generateHash(l),l.uid=l.hash,t(l)):s.read(e,f,function(e){l.uid=f,l.pre=e.data,l.preHash=s.generateHash(e.data),t(l)},function(e,f){i&&i(e,f)})},syncLoop:function(e){s.getDataSet(e,function(f){f.syncPending=!1,f.syncRunning=!0,f.syncLoopStart=(new Date).getTime(),s.doNotify(e,null,s.notifications.SYNC_STARTED,null),s.isOnline(function(n){if(n){var o={};o.fn="sync",o.dataset_id=e,o.query_params=f.query_params,o.config=f.config,o.meta_data=f.meta_data,o.dataset_hash=f.hash,o.acknowledgements=f.acknowledgements||[];var d=f.pending,i=[];for(var t in d)d[t].inFlight||d[t].crashed||d[t].delayed||(d[t].inFlight=!0,d[t].inFlightDate=(new Date).getTime(),i.push(d[t])),s.shouldResendInflightPending(f,d[t])&&i.push(d[t]);o.pending=i,i.length>0&&s.consoleLog("Starting sync loop - global hash = "+f.hash+" :: params = "+JSON.stringify(o,null,2)),s.doCloudCall({dataset_id:e,req:o},function(n){function o(n,o,i){if(n)for(var t in n)d=n[t],i.push(d),f.pending[t]&&f.pending[t].inFlight&&(delete f.pending[t],s.doNotify(e,d.uid,o,d))}var d;if(s.updateCrashedInFlightFromNewData(e,f,n),s.updateDelayedFromNewData(e,f,n),s.updateMetaFromNewData(e,f,n),n.updates){var i=[];s.checkUidChanges(f,n.updates.applied),o(n.updates.applied,s.notifications.REMOTE_UPDATE_APPLIED,i),o(n.updates.failed,s.notifications.REMOTE_UPDATE_FAILED,i),o(n.updates.collisions,s.notifications.COLLISION_DETECTED,i),f.acknowledgements=i}n.hash&&n.hash!==f.hash?(s.consoleLog("Local dataset stale - syncing records :: local hash= "+f.hash+" - remoteHash="+n.hash),s.syncRecords(e)):(s.consoleLog("Local dataset up to date"),s.syncComplete(e,"online",s.notifications.SYNC_COMPLETE))},function(n,o){s.markInFlightAsCrashed(f),s.consoleLog("syncLoop failed : msg="+n+" :: err = "+o),s.syncComplete(e,n,s.notifications.SYNC_FAILED)})}else s.syncComplete(e,"offline",s.notifications.SYNC_FAILED)})})},syncRecords:function(e){s.getDataSet(e,function(f){var n=f.data||{},o={};for(var d in n){var i=d,t=n[d].hash;o[i]=t}var l={};l.fn="syncRecords",l.dataset_id=e,l.query_params=f.query_params,l.clientRecs=o,s.consoleLog("syncRecParams :: "+JSON.stringify(l)),s.doCloudCall({dataset_id:e,req:l},function(o){s.consoleLog("syncRecords Res before applying pending changes :: "+JSON.stringify(o)),s.applyPendingChangesToRecords(f,o),s.consoleLog("syncRecords Res after apply pending changes :: "+JSON.stringify(o));var d;if(o.create)for(d in o.create)n[d]={hash:o.create[d].hash,data:o.create[d].data},s.doNotify(e,d,s.notifications.RECORD_DELTA_RECEIVED,"create");if(o.update)for(d in o.update)n[d].hash=o.update[d].hash,n[d].data=o.update[d].data,s.doNotify(e,d,s.notifications.RECORD_DELTA_RECEIVED,"update");if(o["delete"])for(d in o["delete"])delete n[d],s.doNotify(e,d,s.notifications.RECORD_DELTA_RECEIVED,"delete");s.doNotify(e,o.hash,s.notifications.DELTA_RECEIVED,"partial dataset"),f.data=n,o.hash&&(f.hash=o.hash),s.syncComplete(e,"online",s.notifications.SYNC_COMPLETE)},function(f,n){s.consoleLog("syncRecords failed : msg="+f+" :: err="+n),s.syncComplete(e,f,s.notifications.SYNC_FAILED)})})},syncComplete:function(e,f,n){s.getDataSet(e,function(o){o.syncRunning=!1,o.syncLoopEnd=(new Date).getTime();var d=o.query_params;d.manualRefresh=!1,o.query_params=d,s.saveDataSet(e),s.doNotify(e,o.hash,n,f)})},applyPendingChangesToRecords:function(e,f){var n=e.pending;for(var o in n)if(n.hasOwnProperty(o)){var d=n[o],i=d.uid;if(f.create){var t=f.create;t&&t[i]&&delete t[i]}if(f.update){var l=f.update;l&&l[i]&&delete l[i]}if(f["delete"]){var s=f["delete"];s&&s[i]&&delete s[i]}}},checkUidChanges:function(e,f){if(f){var n={},o=0;for(var d in f)if(f.hasOwnProperty(d)){var i=f[d],t=i.action;if(t&&"create"===t){var l=i.uid,u=i.hash;o++,s.uid_map[u]=l,n[u]=l;var p=e.data[u];p&&(e.data[l]=p,delete e.data[u]);var c=e.meta[u];c&&(e.meta[l]=c,delete e.meta[u])}}if(o>0)for(var y in e.pending)if(e.pending.hasOwnProperty(y)){var a=e.pending[y],r=a.uid;n[r]&&(a.uid=n[r])}}},checkDatasets:function(){for(var e in s.datasets)if(s.datasets.hasOwnProperty(e)){var f=s.datasets[e];if(f&&!f.syncRunning&&(f.config.sync_active||f.syncForced)){var n=f.syncLoopStart,o=f.syncLoopEnd;if(f.syncForced)f.syncPending=!0;else if(null==n)s.consoleLog(e+" - Performing initial sync"),f.syncPending=!0;else if(null!=o){var d=(new Date).getTime()-o,i=1e3*f.config.sync_frequency;d>i&&(f.syncPending=!0)}f.syncPending&&(f.syncForced=!1,s.syncLoop(e))}}},setCloudHandler:function(e){e&&"function"==typeof e?s.cloudHandler=e:s.consoleLog("setCloudHandler called  with wrong parameter")},doCloudCall:function(e,f,n){s.cloudHandler&&"function"==typeof s.cloudHandler?(e&&e.req&&(e.req.__fh={cuid:t.getClientId()}),s.cloudHandler(e,f,n)):console.log("Missing cloud handler for sync. Please refer to documentation")},datasetMonitor:function(){s.checkDatasets(),setTimeout(function(){s.datasetMonitor()},500)},setStorageAdapter:function(e){s.getStorageAdapter=e},setHashMethod:function(e){e&&"function"==typeof e?s.getHashMethod=e:s.consoleLog("setHashMethod called  with wrong parameter")},getStorageAdapter:function(e,f,n){var o=function(n,o){var d=(f?"save to":"load from")+" local storage failed msg: "+n+" err: "+o;s.doNotify(e,null,s.notifications.CLIENT_STORAGE_FAILED,d),s.consoleLog(d)};d({fail:o,adapter:s.config.storage_strategy,size:s.config.file_system_quota,backup:s.config.icloud_backup},function(){return n(null,this)})},getHashMethod:o.SHA1,saveDataSet:function(e,f){s.getDataSet(e,function(n){s.getStorageAdapter(e,!0,function(o,d){d.save({key:"dataset_"+e,val:n},function(){return f?f():void 0})})})},loadDataSet:function(e,f,n){s.getStorageAdapter(e,!1,function(o,d){d.get("dataset_"+e,function(o){if(o&&o.val){var d=o.val;if("string"==typeof d&&(d=JSON.parse(d)),d.initialised=!1,s.datasets[e]=d,s.consoleLog("load from local storage success for dataset_id :"+e),f)return f(d)}else if(n)return n()})})},clearCache:function(e,f){delete s.datasets[e],s.notify_callback_map[e]=null,s.getStorageAdapter(e,!0,function(n,o){o.remove("dataset_"+e,function(){return s.consoleLog("local cache is cleared for dataset : "+e),f?f():void 0})})},updateDatasetFromLocal:function(e,f){var n,o,d=e.pending,i=f.uid;s.consoleLog("updating local dataset for uid "+i+" - action = "+f.action),e.meta[i]=e.meta[i]||{},"create"===f.action&&(e.data[i]&&(s.consoleLog("dataset already exists for uid in create :: "+JSON.stringify(e.data[i])),e.meta[i].fromPending&&(n=e.meta[i].pendingUid,delete d[n])),e.data[i]={}),"update"===f.action&&e.data[i]&&e.meta[i].fromPending&&(s.consoleLog("updating an existing pending record for dataset :: "+JSON.stringify(e.data[i])),n=e.meta[i].pendingUid,o=d[n],o&&(o.inFlight?(s.consoleLog("existing in-inflight pending record = "+JSON.stringify(o)),f.delayed=!0,f.waiting=o.hash):(s.consoleLog("existing pre-flight pending record = "+JSON.stringify(o)),o.post=f.post,o.postHash=f.postHash,delete d[f.hash],f.hash=n))),"delete"===f.action&&e.data[i]&&(e.meta[i].fromPending&&(s.consoleLog("Deleting an existing pending record for dataset :: "+JSON.stringify(e.data[i])),n=e.meta[i].pendingUid,o=d[n],o&&(o.inFlight?(s.consoleLog("existing in-inflight pending record = "+JSON.stringify(o)),f.delayed=!0,f.waiting=o.hash):(s.consoleLog("existing pending record = "+JSON.stringify(o)),"create"===o.action&&(delete d[f.hash],delete d[n]),"update"===o.action&&(f.pre=o.pre,f.preHash=o.preHash,f.inFlight=!1,delete d[n])))),delete e.data[i]),e.data[i]&&(e.data[i].data=f.post,e.data[i].hash=f.postHash,e.meta[i].fromPending=!0,e.meta[i].pendingUid=f.hash)},updateCrashedInFlightFromNewData:function(e,f,n){var o,d,i=({applied:s.notifications.REMOTE_UPDATE_APPLIED,failed:s.notifications.REMOTE_UPDATE_FAILED,collisions:s.notifications.COLLISION_DETECTED},f.pending);if(i){for(o in i)if(i.hasOwnProperty(o)&&(d=i[o],d.inFlight&&d.crashed))if(s.consoleLog("updateCrashedInFlightFromNewData - Found crashed inFlight pending record uid="+d.uid+" :: hash="+d.hash),n&&n.updates&&n.updates.hashes){var t=n.updates.hashes[o];t||(d.crashedCount?d.crashedCount++:d.crashedCount=1)}else d.crashedCount?d.crashedCount++:d.crashedCount=1;for(o in i)i.hasOwnProperty(o)&&(d=i[o],d.inFlight&&d.crashed&&d.crashedCount>f.config.crashed_count_wait&&(s.consoleLog("updateCrashedInFlightFromNewData - Crashed inflight pending record has reached crashed_count_wait limit : "+JSON.stringify(d)),s.consoleLog("updateCrashedInFlightFromNewData - Retryig crashed inflight pending record"),d.crashed=!1,d.inFlight=!1))}},updateDelayedFromNewData:function(e,f,n){var o,d,i=f.pending;if(i)for(o in i)if(i.hasOwnProperty(o)&&(d=i[o],d.delayed&&d.waiting&&(s.consoleLog("updateDelayedFromNewData - Found delayed pending record uid="+d.uid+" :: hash="+d.hash+" :: waiting="+d.waiting),n&&n.updates&&n.updates.hashes))){var t=n.updates.hashes[d.waiting];t&&(s.consoleLog("updateDelayedFromNewData - Waiting pending record is resolved rec="+JSON.stringify(t)),d.delayed=!1,d.waiting=void 0)}},updateMetaFromNewData:function(e,f,n){var o=f.meta;if(o&&n&&n.updates&&n.updates.hashes)for(var d in o)if(o.hasOwnProperty(d)){var i=o[d],t=i.pendingUid;s.consoleLog("updateMetaFromNewData - Found metadata with uid = "+d+" :: pendingHash = "+t);var l=!0;if(t){l=!1;var u=n.updates.hashes[t];u&&(s.consoleLog("updateMetaFromNewData - Found pendingUid in meta data resolved - resolved = "+JSON.stringify(u)),i.pendingUid=void 0,l=!0)}l&&(s.consoleLog("updateMetaFromNewData - both previous and current pendings are resolved for meta data with uid "+d+". Delete it."),delete o[d])}},markInFlightAsCrashed:function(e){var f,n,o=e.pending;if(o){var d={};for(f in o)o.hasOwnProperty(f)&&(n=o[f],n.inFlight&&(s.consoleLog("Marking in flight pending record as crashed : "+f),n.crashed=!0,d[n.uid]=n))}},consoleLog:function(e){s.config.do_console_log&&console.log(e)}};!function(){s.config=s.defaults}(),s.setCloudHandler(i.handler),f.exports={init:s.init,manage:s.manage,notify:s.notify,doList:s.list,getUID:s.getUID,doCreate:s.create,doRead:s.read,doUpdate:s.update,doDelete:s["delete"],listCollisions:s.listCollisions,removeCollision:s.removeCollision,getPending:s.getPending,clearPending:s.clearPending,getDataset:s.getDataSet,getQueryParams:s.getQueryParams,setQueryParams:s.setQueryParams,getMetaData:s.getMetaData,setMetaData:s.setMetaData,getConfig:s.getConfig,setConfig:s.setConfig,startSync:s.startSync,stopSync:s.stopSync,doSync:s.doSync,forceSync:s.forceSync,generateHash:s.generateHash,loadDataSet:s.loadDataSet,clearCache:s.clearCache,doCloudCall:s.doCloudCall,setCloudHandler:s.setCloudHandler,setStorageAdapter:s.setStorageAdapter,setHashMethod:s.setHashMethod,setNetworkStatusHandler:s.setNetworkStatusHandler}},{"../libs/generated/crypto":1,"../libs/generated/lawnchair":2,"./clientIdProvider":8,"./cloudHandler":9}]},{},[10])(10)});